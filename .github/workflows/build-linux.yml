name: Build Linux (Flutter)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    env:
      ARTIFACT_NAME: linux-release-${{ github.run_number }}

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar dependencias de sistema (Linux desktop)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libcups2-dev

      - name: Configurar Flutter (stable - latest)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Verificar versiones
        run: |
          flutter --version
          dart --version

      - name: Habilitar Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Resolver dependencias
        run: flutter pub get

      - name: Compilar release para Linux
        run: flutter build linux --release

      - name: Verificar carpeta Release y listar contenido
        shell: bash
        run: |
          candidates=(
            "build/linux/x64/release/bundle"
            "build/linux/arm64/release/bundle"
            "build/linux/release/bundle"
          )
          releaseDir=""
          for p in "${candidates[@]}"; do
            if [ -d "$p" ]; then
              releaseDir="$p"
              break
            fi
          done
          if [ -z "$releaseDir" ]; then
            echo "No se encontró ninguna carpeta Release en: ${candidates[*]}"
            exit 1
          fi

          echo "Carpeta Release detectada: $releaseDir"
          find "$releaseDir" -type f -printf "%s  %p\n" | sort -n
          echo "RELEASE_DIR=$releaseDir" >> "$GITHUB_ENV"

      - name: Empaquetar ZIP
        shell: bash
        run: |
          zipName="${ARTIFACT_NAME}.zip"
          rm -f "$zipName"
          (cd "$RELEASE_DIR" && zip -r "../$zipName" .)
          mv "build/linux/x64/release/$zipName" "./" 2>/dev/null || true
          mv "build/linux/arm64/release/$zipName" "./" 2>/dev/null || true
          [ -f "$zipName" ] || { echo "No se pudo crear $zipName"; exit 1; }
          ls -lh "$zipName"

      - name: Subir artefacto (.zip)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.zip
          if-no-files-found: error
          retention-days: 30
