name: Build Linux (Flutter)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    env:
      FLUTTER_VERSION: '3.32.1'
      ARTIFACT_NAME: linux-release-${{ github.run_number }}

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar dependencias de sistema (Linux desktop)
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Configurar Flutter ${{ env.FLUTTER_VERSION }} (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Verificar versiones
        run: |
          flutter --version
          dart --version

      - name: Habilitar Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Resolver dependencias
        run: flutter pub get

      - name: Compilar release para Linux
        run: flutter build linux --release

      - name: Verificar carpeta Release y listar contenido
        run: |
          RELEASE_DIR="build/linux/x64/release/bundle"
          if [ ! -d "$RELEASE_DIR" ]; then
            echo "No se encontró carpeta de salida: $RELEASE_DIR"
            exit 1
          fi
          echo "Carpeta Release: $RELEASE_DIR"
          find "$RELEASE_DIR" -type f -printf "%s  %p\n" | sort -n

          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV

      - name: Empaquetar ZIP
        run: |
          zip -r "${ARTIFACT_NAME}.zip" "$RELEASE_DIR"
          ls -lh "${ARTIFACT_NAME}.zip"

      - name: Subir artefacto (.zip)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.zip
          if-no-files-found: error
          retention-days: 30
